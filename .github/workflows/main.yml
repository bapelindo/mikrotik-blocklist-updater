name: Update MikroTik Blocklist

on:
  schedule:
    - cron: '0 2 * * 1' # Berjalan setiap Senin jam 2 pagi
  workflow_dispatch: # Tombol untuk menjalankan manual

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate Blocklist File
        run: |
          #!/bin/bash
          ASN_LIST=("16509" "14618" "37963" "45102" "55967" "14061" "31898" "24940")
          FILENAME="Cloud_Blocklist.rsc"

          echo "# Generated on $(date)" > $FILENAME
          echo "/ip firewall address-list" > $FILENAME
          echo "remove [find list=Cloud_Blocklist]" >> $FILENAME

          for ASN in "${ASN_LIST[@]}"; do
            echo "--> Memproses ASN: $ASN"
            
            # Menggunakan curl untuk mengambil data dan kode status HTTP secara terpisah
            HTTP_STATUS=$(curl -s -o data.out -w "%{http_code}" "https://stat.ripe.net/data/announced-prefixes/data.txt?resource=AS$ASN")
            
            echo "Server Response Code: $HTTP_STATUS"

            # Hanya proses file jika statusnya 200 (OK)
            if [ "$HTTP_STATUS" -eq 200 ]; then
              cat data.out | grep -E '^[0-9]+\.' | \
              sed -e "s/^/add list=Cloud_Blocklist address=/" -e "s/$/ comment=ASN:$ASN/" >> $FILENAME
            else
              echo "PERINGATAN: Gagal mengambil data untuk ASN $ASN. Server merespons dengan kode $HTTP_STATUS."
            fi
          done
          echo "# Update Complete" >> $FILENAME

      - name: Update Gist using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh gist edit "$GIST_ID" Cloud_Blocklist.rsc
